<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cool Now Login</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">

<style>
body { font-family: 'Kanit', sans-serif; }

.fade {
  animation: fade .35s ease;
}
@keyframes fade {
  from { opacity:0; transform: scale(.95); }
  to { opacity:1; transform: scale(1); }
}

.checkmark {
  width: 72px; height: 72px;
  border-radius: 50%;
  background: #22c55e;
  display:flex; align-items:center; justify-content:center;
  color:white; font-size:40px;
  animation: pop .4s ease;
}
@keyframes pop {
  0% { transform: scale(0); }
  80% { transform: scale(1.1); }
  100% { transform: scale(1); }
}
</style>
</head>

<body class="bg-[#FBFBFD] min-h-screen flex items-center justify-center">

<!-- LOGIN -->
<div id="loginSection" class="bg-white p-8 rounded-3xl shadow-xl w-full max-w-md text-center fade">
  <h2 class="text-2xl font-bold mb-6">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>

  <button id="googleLoginBtn"
    class="w-full border py-4 rounded-xl flex justify-center gap-2 mb-3 font-bold">
    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5">
    Google
  </button>

  <button id="phoneLoginBtn"
    class="w-full bg-pink-500 text-white py-4 rounded-xl font-bold">
    üì± ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ + OTP
  </button>
</div>

<!-- PHONE MODAL -->
<div id="phoneModal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50">
<div class="bg-white p-6 rounded-3xl w-full max-w-sm text-center fade relative">

<!-- STEP 1 -->
<div id="step1">
  <h3 class="text-xl font-bold mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå</h3>
  <input id="phoneInput" type="tel" maxlength="10"
    placeholder="08xxxxxxxx"
    class="w-full p-4 bg-gray-50 rounded-xl mb-4 text-center text-lg">

  <div id="recaptcha-container" class="flex justify-center mb-4 scale-90"></div>

  <button id="sendOtpBtn"
    class="w-full bg-pink-500 text-white py-4 rounded-xl font-bold">
    ‡∏™‡πà‡∏á OTP
  </button>
</div>

<!-- STEP 2 -->
<div id="step2" class="hidden">
  <h3 class="text-xl font-bold mb-2">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ OTP</h3>

  <input id="otpInput"
    type="text"
    inputmode="numeric"
    autocomplete="one-time-code"
    maxlength="6"
    class="w-full p-4 bg-gray-50 rounded-xl mb-4
           text-center text-3xl tracking-widest font-bold">

  <button id="verifyOtpBtn"
    class="w-full bg-green-500 text-white py-4 rounded-xl font-bold">
    ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
  </button>

  <p id="countdownText" class="text-sm text-gray-400 mt-4"></p>
</div>

<!-- SUCCESS -->
<div id="successStep" class="hidden flex flex-col items-center">
  <div class="checkmark mb-4">‚úì</div>
  <p class="font-bold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>
</div>

</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth, onAuthStateChanged,
  signInWithRedirect, GoogleAuthProvider,
  RecaptchaVerifier, signInWithPhoneNumber
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCQGbSSIqRjLblQsY565li1YxXGFQrHxYc",
  authDomain: "coolnow-1d8f4.firebaseapp.com",
  projectId: "coolnow-1d8f4"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
auth.languageCode = 'th';

const provider = new GoogleAuthProvider();

// redirect ‡∏´‡∏•‡∏±‡∏á login
onAuthStateChanged(auth, user => {
  if (user) location.href = "index.html";
});

// Google (‡πÑ‡∏°‡πà popup)
googleLoginBtn.onclick = () => signInWithRedirect(auth, provider);

// Phone modal
phoneLoginBtn.onclick = () => {
  phoneModal.classList.remove('hidden');
  if (!window.recaptchaVerifier) {
    window.recaptchaVerifier =
      new RecaptchaVerifier(auth, 'recaptcha-container');
    recaptchaVerifier.render();
  }
};

let confirmationResult;

// SEND OTP
sendOtpBtn.onclick = async () => {
  if (sendOtpBtn.disabled) return;

  const num = phoneInput.value;
  if (num.length !== 10) return alert('‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å');

  sendOtpBtn.disabled = true;
  sendOtpBtn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';

  const phone = '+66' + num.slice(1);

  try {
    confirmationResult =
      await signInWithPhoneNumber(auth, phone, recaptchaVerifier);

    step1.classList.add('hidden');
    step2.classList.remove('hidden');
    otpInput.focus();

    // countdown
    let sec = 60;
    countdownText.innerText = `‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ô ${sec} ‡∏ß‡∏¥`;
    const timer = setInterval(() => {
      sec--;
      countdownText.innerText = `‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ô ${sec} ‡∏ß‡∏¥`;
      if (sec <= 0) clearInterval(timer);
    }, 1000);

    // Android auto-read
    if ('OTPCredential' in window) {
      navigator.credentials.get({
        otp: { transport: ['sms'] }
      }).then(otp => {
        otpInput.value = otp.code;
        verifyOtpBtn.click();
      }).catch(()=>{});
    }

  } catch {
    alert('‡∏™‡πà‡∏á OTP ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    sendOtpBtn.disabled = false;
    sendOtpBtn.innerText = '‡∏™‡πà‡∏á OTP';
  }
};

// auto submit
otpInput.addEventListener('input', () => {
  if (otpInput.value.length === 6) verifyOtpBtn.click();
});

// VERIFY
verifyOtpBtn.onclick = async () => {
  if (verifyOtpBtn.disabled) return;
  verifyOtpBtn.disabled = true;
  verifyOtpBtn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';

  try {
    await confirmationResult.confirm(otpInput.value);
    step2.classList.add('hidden');
    successStep.classList.remove('hidden');
  } catch {
    alert('OTP ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
    verifyOtpBtn.disabled = false;
    verifyOtpBtn.innerText = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
  }
};
</script>

</body>
</html>
