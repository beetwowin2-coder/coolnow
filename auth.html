<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cool Now Login</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">

<style>
body { font-family: 'Kanit', sans-serif; }
.fade { animation: fade .35s ease; }
@keyframes fade {
  from { opacity:0; transform: scale(.95); }
  to { opacity:1; transform: scale(1); }
}
.checkmark {
  width:72px;height:72px;border-radius:50%;
  background:#22c55e;
  display:flex;align-items:center;justify-content:center;
  color:white;font-size:40px;
  animation:pop .4s ease;
}
@keyframes pop {
  0%{transform:scale(0)}
  80%{transform:scale(1.1)}
  100%{transform:scale(1)}
}
</style>
</head>

<body class="bg-[#FBFBFD] min-h-screen flex items-center justify-center">

<div class="bg-white p-8 rounded-3xl shadow-xl w-full max-w-md text-center fade">
  <h2 class="text-2xl font-bold mb-6">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>

  <button id="googleLoginBtn"
    class="w-full border py-4 rounded-xl flex justify-center gap-2 mb-3 font-bold">
    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5">
    Google
  </button>

  <button id="phoneLoginBtn"
    class="w-full bg-pink-500 text-white py-4 rounded-xl font-bold">
    üì± ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ + OTP
  </button>
</div>

<!-- PHONE MODAL -->
<div id="phoneModal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50">
<div class="bg-white p-6 rounded-3xl w-full max-w-sm text-center fade relative">

<button id="closeModal" class="absolute top-3 right-4 text-gray-400 text-xl">√ó</button>

<!-- STEP 1 -->
<div id="step1">
  <h3 class="text-xl font-bold mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå</h3>
  <input id="phoneInput" maxlength="10"
    class="w-full p-4 bg-gray-50 rounded-xl mb-4 text-center text-lg"
    placeholder="08xxxxxxxx">
  <div class="flex justify-center mb-4">
    <div id="recaptcha-container"></div>
  </div>
  <button id="sendOtpBtn"
    class="w-full bg-pink-500 text-white py-4 rounded-xl font-bold">
    ‡∏™‡πà‡∏á OTP
  </button>
</div>

<!-- STEP 2 -->
<div id="step2" class="hidden">
  <h3 class="text-xl font-bold mb-2">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ OTP</h3>
  <input id="otpInput"
    inputmode="numeric"
    autocomplete="one-time-code"
    maxlength="6"
    class="w-full p-4 bg-gray-50 rounded-xl mb-4
    text-center text-3xl tracking-widest font-bold">
  <button id="verifyOtpBtn"
    class="w-full bg-green-500 text-white py-4 rounded-xl font-bold">
    ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
  </button>
  <p id="countdown" class="text-sm text-gray-400 mt-3"></p>
</div>

<!-- SUCCESS -->
<div id="successStep" class="hidden flex flex-col items-center">
  <div class="checkmark mb-4">‚úì</div>
  <p class="font-bold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>
</div>

</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth, onAuthStateChanged,
  signInWithRedirect, getRedirectResult,
  GoogleAuthProvider, RecaptchaVerifier,
  signInWithPhoneNumber
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCQGbSSIqRjLblQsY565li1YxXGFQrHxYc",
  authDomain: "coolnow-1d8f4.firebaseapp.com",
  projectId: "coolnow-1d8f4"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
auth.languageCode = 'th';

const provider = new GoogleAuthProvider();
let confirmationResult;
let recaptchaVerifier;
let cooldown = 60;
let timer;

// handle Google redirect
getRedirectResult(auth).then(r => {
  if (r?.user) location.href = "index.html";
}).catch(()=>{});

// already login
onAuthStateChanged(auth, user => {
  if (user) location.href = "index.html";
});

// Google
googleLoginBtn.onclick = () => signInWithRedirect(auth, provider);

// Phone modal
phoneLoginBtn.onclick = () => {
  phoneModal.classList.remove('hidden');
  if (!recaptchaVerifier) {
    recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', { size:'normal' });
    recaptchaVerifier.render();
  }
};

closeModal.onclick = () => {
  phoneModal.classList.add('hidden');
  step1.classList.remove('hidden');
  step2.classList.add('hidden');
};

// Send OTP
sendOtpBtn.onclick = async () => {
  const num = phoneInput.value;
  if (num.length !== 10) return alert('‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å');

  sendOtpBtn.disabled = true;
  sendOtpBtn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';

  try {
    confirmationResult = await signInWithPhoneNumber(
      auth, '+66'+num.slice(1), recaptchaVerifier
    );
    step1.classList.add('hidden');
    step2.classList.remove('hidden');
    otpInput.focus();
    startCooldown();

    if ('OTPCredential' in window) {
      navigator.credentials.get({ otp:{transport:['sms']} })
        .then(o=>{
          otpInput.value=o.code;
          verifyOtpBtn.click();
        }).catch(()=>{});
    }

  } catch {
    alert('‡∏™‡πà‡∏á OTP ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    sendOtpBtn.disabled=false;
    sendOtpBtn.innerText='‡∏™‡πà‡∏á OTP';
  }
};

// auto submit
otpInput.addEventListener('input',()=>{
  if (otpInput.value.length===6) verifyOtpBtn.click();
});

// verify
verifyOtpBtn.onclick = async () => {
  verifyOtpBtn.disabled=true;
  verifyOtpBtn.innerText='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';
  try {
    await confirmationResult.confirm(otpInput.value);
    step2.classList.add('hidden');
    successStep.classList.remove('hidden');
  } catch {
    alert('OTP ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å');
    verifyOtpBtn.disabled=false;
    verifyOtpBtn.innerText='‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
  }
};

function startCooldown(){
  cooldown=60;
  countdown.innerText=`‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ô ${cooldown} ‡∏ß‡∏¥`;
  timer=setInterval(()=>{
    cooldown--;
    countdown.innerText=`‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ô ${cooldown} ‡∏ß‡∏¥`;
    if(cooldown<=0) clearInterval(timer);
  },1000);
}
</script>

</body>
</html>
