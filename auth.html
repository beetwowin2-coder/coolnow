<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Login</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-br from-blue-100 to-purple-100 min-h-screen flex items-center justify-center">

<div class="bg-white p-6 rounded-xl shadow-xl w-[320px] text-center">
  <h1 class="text-xl font-bold mb-4">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h1>

  <button id="googleLoginBtn"
    class="w-full bg-red-500 text-white py-2 rounded-lg mb-3 hover:bg-red-600 transition">
    Login with Google
  </button>

  <button id="phoneLoginBtn"
    class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition">
    Login with Phone
  </button>
</div>

<!-- OTP MODAL -->
<div id="phoneModal"
  class="fixed inset-0 bg-black/40 hidden items-center justify-center">
  <div class="bg-white p-5 rounded-xl w-[300px] text-center relative">
    <button id="closeModal" class="absolute right-3 top-2">‚úï</button>

    <div id="step1">
      <h2 class="font-bold mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</h2>
      <input id="phoneInput" type="tel" placeholder="0XXXXXXXXX"
        class="border w-full p-2 rounded mb-3 text-center" />
      <div id="recaptcha-container" class="mb-2"></div>
      <button id="sendOtpBtn"
        class="bg-blue-500 text-white w-full py-2 rounded">
        ‡∏™‡πà‡∏á OTP
      </button>
    </div>

    <div id="step2" class="hidden">
      <h2 class="font-bold mb-2">‡∏Å‡∏£‡∏≠‡∏Å OTP</h2>
      <input id="otpInput" maxlength="6"
        class="border w-full p-2 rounded mb-3 text-center tracking-widest text-lg"/>
      <button id="verifyOtpBtn"
        class="bg-green-500 text-white w-full py-2 rounded">
        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
      </button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,
  GoogleAuthProvider,
  signInWithPopup,
  RecaptchaVerifier,
  signInWithPhoneNumber,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCQGbSSIqRjLblQsY565li1YxXGFQrHxYc",
  authDomain: "coolnow-1d8f4.firebaseapp.com",
  projectId: "coolnow-1d8f4"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
auth.languageCode = 'th';

const provider = new GoogleAuthProvider();
let confirmationResult;
let recaptchaVerifier;

// üîÅ ‡∏ñ‡πâ‡∏≤ login ‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏î‡πâ‡∏á‡∏≠‡∏≠‡∏Å
onAuthStateChanged(auth, user => {
  if (user) location.href = "index.html";
});

// üî¥ Google Login
googleLoginBtn.onclick = async () => {
  try {
    await signInWithPopup(auth, provider);
    location.href = "index.html";
  } catch (e) {
    alert("Google login error");
    console.error(e);
  }
};

// üì± ‡πÄ‡∏õ‡∏¥‡∏î OTP
phoneLoginBtn.onclick = () => {
  phoneModal.classList.remove('hidden');
  phoneModal.classList.add('flex');
  if (!recaptchaVerifier) {
    recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', { size: 'normal' });
    recaptchaVerifier.render();
  }
};

// ‚ùå ‡∏õ‡∏¥‡∏î modal
closeModal.onclick = () => {
  phoneModal.classList.add('hidden');
  phoneModal.classList.remove('flex');
  step1.classList.remove('hidden');
  step2.classList.add('hidden');
};

// üì© ‡∏™‡πà‡∏á OTP
sendOtpBtn.onclick = async () => {
  if (phoneInput.value.length !== 10) return alert("‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å");
  sendOtpBtn.disabled = true;
  sendOtpBtn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...";

  try {
    confirmationResult = await signInWithPhoneNumber(
      auth,
      '+66' + phoneInput.value.slice(1),
      recaptchaVerifier
    );
    step1.classList.add('hidden');
    step2.classList.remove('hidden');
    otpInput.focus();
  } catch (e) {
    alert("‡∏™‡πà‡∏á OTP ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ");
    sendOtpBtn.disabled = false;
    sendOtpBtn.innerText = "‡∏™‡πà‡∏á OTP";
  }
};

// üî¢ auto submit OTP
otpInput.addEventListener('input', () => {
  if (otpInput.value.length === 6) verifyOtpBtn.click();
});

// ‚úÖ confirm OTP
verifyOtpBtn.onclick = async () => {
  verifyOtpBtn.disabled = true;
  verifyOtpBtn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...";
  try {
    await confirmationResult.confirm(otpInput.value);
    location.href = "index.html";
  } catch {
    alert("OTP ‡∏ú‡∏¥‡∏î");
    verifyOtpBtn.disabled = false;
    verifyOtpBtn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô";
  }
};
</script>
</body>
</html>
