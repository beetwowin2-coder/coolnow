<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account - Cool Now Store</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Kanit', sans-serif; }
        .loading-screen {
            position: fixed; inset: 0;
            background: white;
            display: flex; align-items: center; justify-content: center;
            z-index: 100;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #eee;
            border-top: 4px solid #ec4899;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none; margin: 0;
        }
    </style>
</head>

<body class="bg-[#FBFBFD] flex flex-col min-h-screen text-gray-800">

<div id="loader" class="loading-screen">
    <div class="spinner"></div>
</div>

<nav class="bg-white/80 backdrop-blur-md sticky top-0 py-4 px-6 flex justify-between shadow-sm z-50">
    <a href="index.html" class="flex items-center gap-2">
        <div class="w-8 h-8 bg-pink-500 rounded-lg flex items-center justify-center text-white font-bold">C</div>
        <span class="font-bold text-lg">COOL NOW</span>
    </a>
    <a href="index.html" class="text-sm text-gray-500 hover:text-pink-500">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
</nav>

<main class="flex-1 flex items-center justify-center p-4">

<!-- PROFILE -->
<div id="profileSection" class="hidden bg-white p-10 rounded-[3rem] shadow-xl max-w-md w-full text-center">
    <div id="userPhoto" class="w-28 h-28 bg-pink-50 rounded-full mx-auto mb-6 flex items-center justify-center">
        <span class="text-5xl">üë§</span>
    </div>
    <h2 id="userName" class="text-2xl font-bold"></h2>
    <p id="userEmail" class="text-gray-400 text-sm mb-8"></p>

    <button onclick="location.href='index.html'"
        class="w-full bg-pink-500 text-white py-4 rounded-2xl font-bold mb-3">
        ‡πÑ‡∏õ‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏¢ üõçÔ∏è
    </button>
    <button id="mainLogoutBtn" class="text-gray-400 hover:text-red-500 text-sm">
        ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
    </button>
</div>

<!-- LOGIN -->
<div id="loginSection" class="hidden bg-white p-10 rounded-[3rem] shadow-xl max-w-md w-full text-center">
    <h2 class="text-2xl font-bold mb-6">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>

    <button id="googleLoginBtn"
        class="w-full border py-4 rounded-2xl font-bold mb-3">
        ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢ Google
    </button>

    <button id="phoneLoginBtn"
        class="w-full bg-pink-500 text-white py-4 rounded-2xl font-bold">
        üì± ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£
    </button>
</div>

<!-- PHONE MODAL -->
<div id="phoneModal"
     class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-[100]">
    <div class="bg-white p-8 rounded-[2rem] w-full max-w-sm relative">
        <button onclick="closePhoneModal()" class="absolute top-4 right-4">‚úï</button>

        <div id="step1">
            <h3 class="font-bold mb-4">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</h3>
            <input id="phoneNumber" maxlength="10" placeholder="08xxxxxxxx"
                   class="w-full p-4 border rounded-xl text-center mb-4">
            <div id="recaptcha-container" class="flex justify-center mb-4"></div>
            <button id="sendOtpBtn"
                class="w-full bg-pink-500 text-white py-4 rounded-xl font-bold">
                ‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™ OTP
            </button>
        </div>

        <div id="step2" class="hidden text-center">
            <p class="mb-4">OTP ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà <span id="targetPhone" class="font-bold text-pink-500"></span></p>
            <input id="otpCode" maxlength="6"
                   class="w-full p-4 border rounded-xl text-center text-2xl mb-4">
            <button id="verifyOtpBtn"
                class="w-full bg-green-500 text-white py-4 rounded-xl font-bold">
                ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™
            </button>
        </div>
    </div>
</div>

</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
    getAuth, onAuthStateChanged,
    signInWithPopup, GoogleAuthProvider,
    signOut, RecaptchaVerifier, signInWithPhoneNumber
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyCQGbSSIqRjLblQsY565li1YxXGFQrHxYc",
    authDomain: "coolnow-1d8f4.firebaseapp.com",
    projectId: "coolnow-1d8f4",
    appId: "1:857055916856:web:c32673482de318e04a07cd"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
auth.languageCode = "th";

const provider = new GoogleAuthProvider();

const loader = document.getElementById("loader");
const profileSection = document.getElementById("profileSection");
const loginSection = document.getElementById("loginSection");
const phoneModal = document.getElementById("phoneModal");

let confirmationResult = null;

onAuthStateChanged(auth, user => {
    loader.style.display = "none";
    if (user) {
        profileSection.classList.remove("hidden");
        loginSection.classList.add("hidden");
        userName.innerText = user.displayName || user.phoneNumber;
        userEmail.innerText = user.email || "";
    } else {
        loginSection.classList.remove("hidden");
        profileSection.classList.add("hidden");
    }
});

/* üî• reCAPTCHA FIX */
function createRecaptcha() {
    if (window.recaptchaVerifier) {
        window.recaptchaVerifier.clear();
        window.recaptchaVerifier = null;
    }
    window.recaptchaVerifier = new RecaptchaVerifier(auth, "recaptcha-container", {
        size: "normal"
    });
    window.recaptchaVerifier.render();
}

phoneLoginBtn.onclick = () => {
    phoneModal.classList.remove("hidden");
    createRecaptcha();
};

sendOtpBtn.onclick = async () => {
    const num = phoneNumber.value.trim();
    if (num.length !== 10) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå 10 ‡∏´‡∏•‡∏±‡∏Å");

    sendOtpBtn.disabled = true;

    try {
        confirmationResult = await signInWithPhoneNumber(
            auth,
            "+66" + num.substring(1),
            window.recaptchaVerifier
        );
        step1.classList.add("hidden");
        step2.classList.remove("hidden");
        targetPhone.innerText = num;
    } catch (e) {
        sendOtpBtn.disabled = false;
        createRecaptcha();
        alert("‡∏™‡πà‡∏á OTP ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    }
};

verifyOtpBtn.onclick = async () => {
    try {
        await confirmationResult.confirm(otpCode.value.trim());
        closePhoneModal();
    } catch {
        alert("OTP ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    }
};

window.closePhoneModal = () => {
    phoneModal.classList.add("hidden");
    if (window.recaptchaVerifier) {
        window.recaptchaVerifier.clear();
        window.recaptchaVerifier = null;
    }
    step1.classList.remove("hidden");
    step2.classList.add("hidden");
};

googleLoginBtn.onclick = () => signInWithPopup(auth, provider);
mainLogoutBtn.onclick = () => signOut(auth);
</script>

</body>
</html>
