<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô - Cool Now</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; }
        .active-push:active { transform: scale(0.98); }
        #uploadZone.drag-over { 
            border-color: #ec4899; 
            background-color: #fdf2f8;
            transform: scale(1.02);
        }
        .qr-container { filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1)); }
        textarea::placeholder, input::placeholder { color: #cbd5e1; font-weight: 300; }
        
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #fff;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏î */
        .qty-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s;
            border: 1px solid #f3f4f6;
        }
    </style>
</head>
<body class="bg-[#FBFBFD] text-gray-800 pb-20">

    <nav class="p-6">
        <a href="index.html" class="text-gray-400 hover:text-gray-600 flex items-center gap-2 transition group">
            <span class="group-hover:-translate-x-1 transition-transform">‚Üê</span> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        </a>
    </nav>

    <main class="container mx-auto max-w-2xl px-4">
        <h1 class="text-3xl font-bold mb-8 text-center md:text-left">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h1>

        <div id="checkoutItems" class="space-y-4 mb-8"></div>

        <section class="bg-white rounded-[2rem] p-8 shadow-sm border border-gray-100 mb-6">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                <span class="text-xl">üìç</span> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á
            </h2>
            
            <div class="space-y-4">
                <div>
                    <label class="text-sm font-bold text-gray-600 mb-1 block ml-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-4 flex items-center text-gray-400">üìû</span>
                        <input type="tel" id="phone" maxlength="10"
                               placeholder="‡πÄ‡∏ä‡πà‡∏ô 0812345678"
                               oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                               class="w-full bg-gray-50 rounded-2xl py-4 pl-12 pr-4 focus:outline-none border border-transparent focus:border-pink-200 focus:bg-white transition-all text-lg tracking-widest">
                    </div>
                </div>

                <div>
                    <label class="text-sm font-bold text-gray-600 mb-1 block ml-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏î‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                    <textarea id="address" 
                            placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á (‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà, ‡πÅ‡∏Ç‡∏ß‡∏á/‡∏ï‡∏≥‡∏ö‡∏•, ‡πÄ‡∏Ç‡∏ï/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠, ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î, ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå)" 
                            class="w-full h-32 bg-gray-50 rounded-2xl p-4 focus:outline-none border border-transparent focus:border-pink-200 focus:bg-white transition-all resize-none"></textarea>
                </div>
            </div>
        </section>

        <section class="bg-white rounded-[2.5rem] p-8 shadow-sm border border-gray-100 mb-8">
            <h2 class="text-lg font-bold mb-6 flex items-center gap-2">
                <span class="text-xl">üí∞</span> ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
            </h2>
            
            <div class="flex flex-col items-center mb-8">
                <div class="bg-white p-6 rounded-3xl border-2 border-blue-500 qr-container text-center max-w-[280px] w-full">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/c/c5/PromptPay-logo.png" class="h-6 mx-auto mb-4" alt="PromptPay">
                    <img id="promptpayQR" src="" class="w-48 h-48 mx-auto rounded-lg shadow-sm" alt="QR Code">
                    <p class="mt-4 font-bold text-blue-900 text-lg">‡∏ì‡∏±‡∏ê‡∏ë‡∏¥‡∏ä‡∏≤ ‡∏™‡∏±‡∏à‡∏à‡∏∞‡∏ß‡∏±‡∏í‡∏ô‡∏∞</p>
                    <p class="text-gray-500 text-sm tracking-widest leading-none mt-1 uppercase">PromptPay QR</p>
                </div>
            </div>
            
            <div class="space-y-4">
                <p class="text-sm font-bold text-gray-700 ml-1">‡πÅ‡∏ô‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</p>
                <div id="uploadZone" 
                     class="relative group cursor-pointer border-2 border-dashed border-pink-200 bg-pink-50/30 rounded-[2rem] p-8 transition-all hover:border-pink-400 hover:bg-pink-50 flex flex-col items-center justify-center min-h-[220px]">
                    <input type="file" id="slipInput" accept="image/*" class="hidden" onchange="previewSlip(this)">
                    <div id="uploadPrompt" class="text-center">
                        <div class="w-16 h-16 bg-white rounded-2xl shadow-sm flex items-center justify-center mx-auto mb-4 text-3xl">üì∏</div>
                        <p class="font-bold text-pink-600 text-sm uppercase">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ</p>
                    </div>
                    <div id="previewContainer" class="hidden w-full flex flex-col items-center">
                        <img id="slipPreview" src="#" class="max-h-64 rounded-xl shadow-md border-2 border-white mb-3">
                        <button type="button" onclick="resetUpload(event)" class="text-xs font-bold text-pink-500 hover:underline">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
                    </div>
                </div>
            </div>
        </section>

        <div class="bg-white rounded-[2.5rem] p-8 shadow-xl shadow-pink-100/30 border border-pink-50">
            <div class="space-y-3 mb-6" id="summaryArea"></div>
            <button id="confirmBtn" onclick="confirmOrder(event)" class="w-full bg-pink-500 text-white py-5 rounded-2xl font-bold text-lg shadow-lg shadow-pink-200 hover:bg-pink-600 transition active-push flex items-center justify-center gap-2">
                ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ üöÄ
            </button>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCQGbSSIqRjLblQsY565li1YxXGFQrHxYc",
            authDomain: "coolnow-1d8f4.firebaseapp.com",
            projectId: "coolnow-1d8f4",
            storageBucket: "coolnow-1d8f4.firebasestorage.app",
            messagingSenderId: "857055916856",
            appId: "1:857055916856:web:c32673482de318e04a07cd"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        window.loggedInUserEmail = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.loggedInUserEmail = user.email;
            } else {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
                window.location.href = 'index.html';
            }
        });
    </script>

    <script>
        let cart = JSON.parse(localStorage.getItem('coolNowCart')) || [];
        let finalTotal = 0;

        function loadSavedAddress() {
            const savedData = JSON.parse(localStorage.getItem('coolNow_CustomerData'));
            if (savedData) {
                document.getElementById('phone').value = savedData.phone || '';
                document.getElementById('address').value = savedData.address || '';
            }
        }

        // --- ‡πÄ‡∏û‡∏¥‡πà‡∏° Logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°-‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ---
        window.updateQty = function(index, change) {
            cart[index].qty += change;
            
            if (cart[index].qty < 1) {
                if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                    cart.splice(index, 1);
                } else {
                    cart[index].qty = 1;
                }
            }
            
            localStorage.setItem('coolNowCart', JSON.stringify(cart));
            renderCheckout();
        }

        function renderCheckout() {
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å cart
            const itemsContainer = document.getElementById('checkoutItems');
            const summaryArea = document.getElementById('summaryArea');
            const qrImg = document.getElementById('promptpayQR');
            const confirmBtn = document.getElementById('confirmBtn');
            
            if (cart.length === 0) {
                itemsContainer.innerHTML = `<div class="bg-white p-12 rounded-[2rem] text-center text-gray-400">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</div>`;
                summaryArea.innerHTML = "";
                qrImg.src = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå QR
                confirmBtn.disabled = true;
                confirmBtn.classList.add('opacity-50', 'cursor-not-allowed');
                return;
            } else {
                confirmBtn.disabled = false;
                confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }

            let subtotal = 0;
            let totalItems = 0;
            let html = '';

            cart.forEach((item, index) => {
                subtotal += item.price * item.qty;
                totalItems += item.qty;
                html += `
                    <div class="bg-white p-4 rounded-[1.8rem] border border-gray-100 flex items-center gap-4 shadow-sm">
                        <img src="${item.img}" class="w-16 h-16 object-contain bg-gray-50 rounded-xl">
                        <div class="flex-1">
                            <h3 class="font-bold text-sm text-gray-700">${item.name}</h3>
                            <p class="text-pink-500 font-bold">${item.price} ‡∏ø</p>
                        </div>
                        <div class="flex items-center gap-2 bg-gray-50 p-1 rounded-xl border">
                            <button onclick="updateQty(${index}, -1)" class="qty-btn bg-white hover:bg-pink-100 text-pink-500 shadow-sm">-</button>
                            <span class="w-6 text-center font-bold text-gray-700">${item.qty}</span>
                            <button onclick="updateQty(${index}, 1)" class="qty-btn bg-white hover:bg-pink-100 text-pink-500 shadow-sm">+</button>
                        </div>
                    </div>`;
            });

            itemsContainer.innerHTML = html;
            const shippingFee = (totalItems >= 2) ? 0 : 40;
            finalTotal = subtotal + shippingFee;

            qrImg.src = `https://promptpay.io/1869900269561/${finalTotal}.png`;

            summaryArea.innerHTML = `
                <div class="flex justify-between text-gray-500 text-sm">
                    <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (${totalItems} ‡∏ä‡∏¥‡πâ‡∏ô)</span>
                    <span>${subtotal.toLocaleString()} ‡∏ø</span>
                </div>
                <div class="flex justify-between text-gray-500 text-sm">
                    <span>‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á ${totalItems >= 2 ? '<span class="text-green-500 text-[10px] ml-1 uppercase font-bold">Free Shipping</span>' : ''}</span>
                    <span>${shippingFee === 0 ? '<span class="text-green-500 font-bold">‡∏ü‡∏£‡∏µ</span>' : '40 ‡∏ø'}</span>
                </div>
                <div class="flex justify-between items-end pt-4 border-t border-dashed mt-2">
                    <span class="text-lg font-bold">‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞</span>
                    <span class="text-3xl font-bold text-pink-500">${finalTotal.toLocaleString()} ‡∏ø</span>
                </div>`;
        }

        function previewSlip(input) {
            const prompt = document.getElementById('uploadPrompt');
            const container = document.getElementById('previewContainer');
            const preview = document.getElementById('slipPreview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    prompt.classList.add('hidden');
                    container.classList.remove('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function resetUpload(event) {
            event.stopPropagation();
            document.getElementById('slipInput').value = "";
            document.getElementById('uploadPrompt').classList.remove('hidden');
            document.getElementById('previewContainer').classList.add('hidden');
        }

        function confirmOrder(event) {
            const phone = document.getElementById('phone').value;
            const address = document.getElementById('address').value;
            const slipFile = document.getElementById('slipInput').files[0];
            const btn = document.getElementById('confirmBtn');

            if (phone.length !== 10) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 10 ‡∏´‡∏•‡∏±‡∏Å');
            if (!address.trim()) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á');
            if (!slipFile) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏™‡∏•‡∏¥‡∏õ)');

            btn.disabled = true;
            btn.innerHTML = `<div class="spinner"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...`;

            const currentUserEmail = window.loggedInUserEmail || 'guest';
            let allHistory = JSON.parse(localStorage.getItem('orderHistory')) || {};
            if (!allHistory[currentUserEmail]) allHistory[currentUserEmail] = [];

            const orderID = "CN" + Math.floor(1000 + Math.random() * 9000);
            const now = new Date();
            
            const newOrder = {
                orderId: orderID,
                total: finalTotal.toLocaleString(),
                date: now.toLocaleDateString('th-TH') + ' ' + now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }),
                items: cart.map(item => ({ name: item.name, qty: item.qty }))
            };

            allHistory[currentUserEmail].unshift(newOrder);
            localStorage.setItem('orderHistory', JSON.stringify(allHistory));
            localStorage.setItem('coolNow_CustomerData', JSON.stringify({ phone, address }));

            const reader = new FileReader();
            reader.onload = function(e) {
                const orderData = {
                    orderId: orderID,
                    customerName: address.split('\n')[0],
                    phone: phone,
                    items: cart.map(i => `${i.name} (x${i.qty})`).join(', '),
                    totalAmount: finalTotal.toLocaleString() + ' ‡∏ø',
                    address: address,
                    slipImage: e.target.result
                };
                sessionStorage.setItem('lastOrder', JSON.stringify(orderData));
                localStorage.removeItem('coolNowCart');
                window.location.href = 'order-success.html';
            };
            reader.readAsDataURL(slipFile);
        }

        const uploadZone = document.getElementById('uploadZone');
        uploadZone.onclick = () => document.getElementById('slipInput').click();
        uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('drag-over'); });
        uploadZone.addEventListener('dragleave', () => { uploadZone.classList.remove('drag-over'); });
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('slipInput').files = files;
                previewSlip(document.getElementById('slipInput'));
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            renderCheckout();
            loadSavedAddress();
        });
    </script>
</body>
</html>
