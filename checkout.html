<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô - Cool Now</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; }
        .active-push:active { transform: scale(0.98); }
        #uploadZone.drag-over { 
            border-color: #ec4899; 
            background-color: #fdf2f8;
            transform: scale(1.02);
        }
        .qr-container { filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1)); }
        textarea::placeholder, input::placeholder { color: #cbd5e1; font-weight: 300; }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #fff;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-[#FBFBFD] text-gray-800 pb-20">

    <nav class="p-6">
        <a href="index.html" class="text-gray-400 hover:text-gray-600 flex items-center gap-2 transition group">
            <span class="group-hover:-translate-x-1 transition-transform">‚Üê</span> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        </a>
    </nav>

    <main class="container mx-auto max-w-2xl px-4">
        <h1 class="text-3xl font-bold mb-8 text-center md:text-left">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h1>

        <div id="checkoutItems" class="space-y-4 mb-8"></div>

        <section class="bg-white rounded-[2rem] p-8 shadow-sm border border-gray-100 mb-6">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                <span class="text-xl">üìç</span> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á
            </h2>
            
            <div class="space-y-4">
                <div>
                    <label class="text-sm font-bold text-gray-600 mb-1 block ml-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-4 flex items-center text-gray-400">üìû</span>
                        <input type="tel" id="phone" maxlength="10"
                               placeholder="‡πÄ‡∏ä‡πà‡∏ô 0812345678"
                               oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                               class="w-full bg-gray-50 rounded-2xl py-4 pl-12 pr-4 focus:outline-none border border-transparent focus:border-pink-200 focus:bg-white transition-all text-lg tracking-widest">
                    </div>
                </div>

                <div>
                    <label class="text-sm font-bold text-gray-600 mb-1 block ml-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏î‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                    <textarea id="address" 
                            placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á (‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà, ‡πÅ‡∏Ç‡∏ß‡∏á/‡∏ï‡∏≥‡∏ö‡∏•, ‡πÄ‡∏Ç‡∏ï/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠, ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î, ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå)" 
                            class="w-full h-32 bg-gray-50 rounded-2xl p-4 focus:outline-none border border-transparent focus:border-pink-200 focus:bg-white transition-all resize-none"></textarea>
                </div>
            </div>
        </section>

        <section class="bg-white rounded-[2.5rem] p-8 shadow-sm border border-gray-100 mb-8">
            <h2 class="text-lg font-bold mb-6 flex items-center gap-2">
                <span class="text-xl">üí∞</span> ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
            </h2>
            
            <div class="flex flex-col items-center mb-8">
                <div class="bg-white p-6 rounded-3xl border-2 border-blue-500 qr-container text-center max-w-[280px] w-full">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/c/c5/PromptPay-logo.png" class="h-6 mx-auto mb-4" alt="PromptPay">
                    <img id="promptpayQR" src="" class="w-48 h-48 mx-auto rounded-lg shadow-sm" alt="QR Code">
                    <p class="mt-4 font-bold text-blue-900 text-lg">‡∏ì‡∏±‡∏ê‡∏ë‡∏¥‡∏ä‡∏≤ ‡∏™‡∏±‡∏à‡∏à‡∏∞‡∏ß‡∏±‡∏í‡∏ô‡∏∞</p>
                    <p class="text-gray-500 text-sm tracking-widest leading-none mt-1 uppercase">PromptPay QR</p>
                </div>
            </div>
            
            <div class="space-y-4">
                <p class="text-sm font-bold text-gray-700 ml-1">‡πÅ‡∏ô‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</p>
                <div id="uploadZone" 
                     class="relative group cursor-pointer border-2 border-dashed border-pink-200 bg-pink-50/30 rounded-[2rem] p-8 transition-all hover:border-pink-400 hover:bg-pink-50 flex flex-col items-center justify-center min-h-[220px]">
                    <input type="file" id="slipInput" accept="image/*" class="hidden" onchange="previewSlip(this)">
                    <div id="uploadPrompt" class="text-center">
                        <div class="w-16 h-16 bg-white rounded-2xl shadow-sm flex items-center justify-center mx-auto mb-4 text-3xl">üì∏</div>
                        <p class="font-bold text-pink-600 text-sm uppercase">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ</p>
                    </div>
                    <div id="previewContainer" class="hidden w-full flex flex-col items-center">
                        <img id="slipPreview" src="#" class="max-h-64 rounded-xl shadow-md border-2 border-white mb-3">
                        <button type="button" onclick="resetUpload(event)" class="text-xs font-bold text-pink-500 hover:underline">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
                    </div>
                </div>
            </div>
        </section>

        <div class="bg-white rounded-[2.5rem] p-8 shadow-xl shadow-pink-100/30 border border-pink-50">
            <div class="space-y-3 mb-6" id="summaryArea"></div>
            <button id="confirmBtn" onclick="confirmOrder(event)" class="w-full bg-pink-500 text-white py-5 rounded-2xl font-bold text-lg shadow-lg shadow-pink-200 hover:bg-pink-600 transition active-push flex items-center justify-center gap-2">
                ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ üöÄ
            </button>
        </div>
    </main>

    <script>
        let cart = JSON.parse(localStorage.getItem('coolNowCart')) || [];
        let finalTotal = 0;

        // 1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏î‡∏¥‡∏°
        function loadSavedAddress() {
            const savedData = JSON.parse(localStorage.getItem('coolNow_CustomerData'));
            if (savedData) {
                document.getElementById('phone').value = savedData.phone || '';
                document.getElementById('address').value = savedData.address || '';
            }
        }

        // 2. ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏á‡∏¥‡∏ô
        function renderCheckout() {
            const itemsContainer = document.getElementById('checkoutItems');
            const summaryArea = document.getElementById('summaryArea');
            const qrImg = document.getElementById('promptpayQR');
            
            if (cart.length === 0) {
                itemsContainer.innerHTML = `<div class="bg-white p-12 rounded-[2rem] text-center text-gray-400">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</div>`;
                document.getElementById('confirmBtn').disabled = true;
                return;
            }

            let subtotal = 0;
            let totalItems = 0;
            let html = '';

            cart.forEach(item => {
                subtotal += item.price * item.qty;
                totalItems += item.qty;
                html += `
                    <div class="bg-white p-4 rounded-[1.8rem] border border-gray-100 flex items-center gap-4 shadow-sm">
                        <img src="${item.img}" class="w-16 h-16 object-contain bg-gray-50 rounded-xl">
                        <div class="flex-1">
                            <h3 class="font-bold text-sm text-gray-700">${item.name}</h3>
                            <p class="text-pink-500 font-bold">${item.price} ‡∏ø</p>
                        </div>
                        <div class="text-right">
                            <span class="font-bold text-gray-400">x ${item.qty}</span>
                        </div>
                    </div>`;
            });

            itemsContainer.innerHTML = html;
            const shippingFee = (totalItems >= 2) ? 0 : 40;
            finalTotal = subtotal + shippingFee;

            // Generate PromptPay QR
            qrImg.src = `https://promptpay.io/1869900269561/${finalTotal}.png`;

            summaryArea.innerHTML = `
                <div class="flex justify-between text-gray-500 text-sm"><span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span><span>${subtotal.toLocaleString()} ‡∏ø</span></div>
                <div class="flex justify-between text-gray-500 text-sm"><span>‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</span><span>${shippingFee === 0 ? '<span class="text-green-500">‡∏ü‡∏£‡∏µ</span>' : '40 ‡∏ø'}</span></div>
                <div class="flex justify-between items-end pt-4 border-t border-dashed mt-2">
                    <span class="text-lg font-bold">‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞</span>
                    <span class="text-3xl font-bold text-pink-500">${finalTotal.toLocaleString()} ‡∏ø</span>
                </div>`;
        }

        // 3. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏•‡∏¥‡∏õ
        function previewSlip(input) {
            const prompt = document.getElementById('uploadPrompt');
            const container = document.getElementById('previewContainer');
            const preview = document.getElementById('slipPreview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    prompt.classList.add('hidden');
                    container.classList.remove('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function resetUpload(event) {
            event.stopPropagation();
            document.getElementById('slipInput').value = "";
            document.getElementById('uploadPrompt').classList.remove('hidden');
            document.getElementById('previewContainer').classList.add('hidden');
        }

        // 4. ‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
        function confirmOrder(event) {
            const phone = document.getElementById('phone').value;
            const address = document.getElementById('address').value;
            const slipFile = document.getElementById('slipInput').files[0];
            const btn = document.getElementById('confirmBtn');

            // Validation
            if (phone.length !== 10) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 10 ‡∏´‡∏•‡∏±‡∏Å');
            if (!address.trim()) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á');
            if (!slipFile) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏™‡∏•‡∏¥‡∏õ)');

            // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Loading
            btn.disabled = true;
            btn.innerHTML = `<div class="spinner"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...`;

            // ‡∏î‡∏∂‡∏á Email ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏ï‡∏≠‡∏ô Login (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏õ‡πÇ‡∏ä‡∏ß‡πå‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏ô)
            const currentUserEmail = localStorage.getItem('lastLoggedInEmail') || 'guest';

            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡∏á LocalStorage (Key: orderHistory ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ index ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ)
            let allHistory = JSON.parse(localStorage.getItem('orderHistory')) || {};
            if (!allHistory[currentUserEmail]) allHistory[currentUserEmail] = [];

            const orderID = "CN" + Math.floor(1000 + Math.random() * 9000);
            const now = new Date();
            
            const newOrder = {
                orderId: orderID,
                total: finalTotal.toLocaleString(),
                date: now.toLocaleDateString('th-TH') + ' ' + now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }),
                items: cart.map(item => ({ name: item.name, qty: item.qty })) // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏ß‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô Modal ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
            };

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏™‡∏∏‡∏î
            allHistory[currentUserEmail].unshift(newOrder);
            localStorage.setItem('orderHistory', JSON.stringify(allHistory));

            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            localStorage.setItem('coolNow_CustomerData', JSON.stringify({ phone, address }));

            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Success
            const reader = new FileReader();
            reader.onload = function(e) {
                const orderData = {
                    orderId: orderID,
                    customerName: address.split('\n')[0],
                    phone: phone,
                    items: cart.map(i => `${i.name} (x${i.qty})`).join(', '),
                    totalAmount: finalTotal.toLocaleString() + ' ‡∏ø',
                    address: address,
                    slipImage: e.target.result
                };
                sessionStorage.setItem('lastOrder', JSON.stringify(orderData));
                
                // ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                localStorage.removeItem('coolNowCart');
                
                // ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                window.location.href = 'order-success.html';
            };
            reader.readAsDataURL(slipFile);
        }

        // 5. Drag & Drop
        const uploadZone = document.getElementById('uploadZone');
        uploadZone.onclick = () => document.getElementById('slipInput').click();
        uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('drag-over'); });
        uploadZone.addEventListener('dragleave', () => { uploadZone.classList.remove('drag-over'); });
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('slipInput').files = files;
                previewSlip(document.getElementById('slipInput'));
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            renderCheckout();
            loadSavedAddress();
        });
    </script>
</body>
</html>
